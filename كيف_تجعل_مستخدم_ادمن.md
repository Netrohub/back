# 🔑 كيفية جعل مستخدم أدمن

## 📋 نظرة عامة

في v2.0، الأدوار (Roles) تُدار من خلال علاقة **many-to-many**:
- جدول `users` (المستخدمين)
- جدول `roles` (الأدوار)
- جدول `user_roles` (ربط المستخدمين بالأدوار)

---

## ⚡ الطريقة السريعة: SQL مباشر

### الخطوة 1: ابحث عن ID المستخدم
```sql
-- بحث بالإيميل
SELECT id, username, email FROM users WHERE email = 'user@example.com';

-- أو بحث باليوزرنيم
SELECT id, username, email FROM users WHERE username = 'johndoe';
```

### الخطوة 2: أضف دور الأدمن للمستخدم

```sql
-- استبدل USER_ID برقم المستخدم الذي ظهر من الخطوة 1
INSERT INTO user_roles (user_id, role_id, granted_at)
VALUES (
    USER_ID,  -- ضع رقم المستخدم هنا
    (SELECT id FROM roles WHERE slug = 'admin'),
    NOW()
)
ON CONFLICT (user_id, role_id) DO NOTHING;
```

---

## 🎯 أمثلة جاهزة

### مثال 1: جعل مستخدم أدمن برقمه (ID)
```sql
-- لو المستخدم رقمه 1
INSERT INTO user_roles (user_id, role_id, granted_at)
VALUES (
    1,
    (SELECT id FROM roles WHERE slug = 'admin'),
    NOW()
)
ON CONFLICT DO NOTHING;
```

### مثال 2: جعل مستخدم أدمن بالإيميل
```sql
-- استبدل البريد الإلكتروني بالبريد الفعلي
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW()
FROM users u, roles r
WHERE u.email = 'test@test.com' AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

### مثال 3: جعل مستخدم أدمن باليوزرنيم
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW()
FROM users u, roles r
WHERE u.username = 'johndoe' AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

---

## 🔍 التحقق من نجاح العملية

### اعرض أدوار مستخدم معين
```sql
SELECT 
    u.id,
    u.username,
    u.email,
    r.slug as الدور,
    r.name as اسم_الدور,
    ur.granted_at as تاريخ_المنح
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.email = 'test@test.com';
```

**النتيجة المتوقعة:**
```
id | username | email          | الدور | اسم_الدور | تاريخ_المنح
---+----------+----------------+-------+-----------+-------------
 1 | johndoe  | test@test.com  | admin | Admin     | 2025-10-28
 1 | johndoe  | test@test.com  | user  | User      | 2025-10-20
```

### اعرض جميع الأدمنز
```sql
SELECT 
    u.id,
    u.username,
    u.email,
    u.created_at
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE r.slug = 'admin'
ORDER BY u.created_at DESC;
```

---

## 📋 خطوات مفصلة للمبتدئين

### 1️⃣ افتح phpMyAdmin أو PostgreSQL Client

**في Hostinger:**
- لوحة التحكم → Databases → phpMyAdmin

**في Render:**
- Dashboard → Your PostgreSQL Service → Connect

### 2️⃣ افتح تبويب SQL

### 3️⃣ نفذ الاستعلام الأول (البحث عن المستخدم)
```sql
SELECT id, username, email FROM users WHERE email = 'test@test.com';
```

**مثال على النتيجة:**
```
id | username | email
---+----------+----------------
 5 | johndoe  | test@test.com
```

**احفظ الـ ID** (في المثال: 5)

### 4️⃣ نفذ استعلام منح الأدمن

**الطريقة 1 (باستخدام ID):**
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
VALUES (
    5,  -- ضع الـ ID اللي طلع معك
    (SELECT id FROM roles WHERE slug = 'admin'),
    NOW()
)
ON CONFLICT DO NOTHING;
```

**الطريقة 2 (مباشرة بالإيميل):**
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW()
FROM users u, roles r
WHERE u.email = 'test@test.com' AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

### 5️⃣ تحقق من النجاح
```sql
SELECT 
    u.username,
    u.email,
    STRING_AGG(r.slug, ', ') as الأدوار
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.email = 'test@test.com'
GROUP BY u.id, u.username, u.email;
```

**النتيجة المتوقعة:**
```
username | email          | الأدوار
---------+----------------+--------------
johndoe  | test@test.com  | user, admin
```

✅ **نجحت العملية!**

---

## 🎯 أوامر سريعة (نسخ ولصق)

### أمر واحد: جعل مستخدم أدمن بالإيميل
```sql
INSERT INTO user_roles (user_id, role_id, granted_at) SELECT u.id, r.id, NOW() FROM users u, roles r WHERE u.email = 'البريد_هنا@example.com' AND r.slug = 'admin' ON CONFLICT DO NOTHING;
```

**استخدام:**
1. انسخ الأمر أعلاه
2. استبدل `البريد_هنا@example.com` بالبريد الفعلي
3. نفذ في SQL

### أمر واحد: جعل مستخدم أدمن باليوزرنيم
```sql
INSERT INTO user_roles (user_id, role_id, granted_at) SELECT u.id, r.id, NOW() FROM users u, roles r WHERE u.username = 'اليوزرنيم_هنا' AND r.slug = 'admin' ON CONFLICT DO NOTHING;
```

---

## ❌ إزالة دور الأدمن

إذا أردت إزالة صلاحيات الأدمن من مستخدم:

```sql
-- بالإيميل
DELETE FROM user_roles
WHERE user_id = (SELECT id FROM users WHERE email = 'test@test.com')
AND role_id = (SELECT id FROM roles WHERE slug = 'admin');
```

```sql
-- بالـ ID
DELETE FROM user_roles
WHERE user_id = 5
AND role_id = (SELECT id FROM roles WHERE slug = 'admin');
```

---

## 📚 الأدوار المتاحة

لمعرفة جميع الأدوار الموجودة:

```sql
SELECT id, slug, name, description FROM roles ORDER BY slug;
```

**الأدوار الشائعة:**
- `admin` - صلاحيات كاملة
- `user` - مستخدم عادي
- `seller` - بائع (يمكنه عرض منتجات)
- `moderator` - مشرف (إن وُجد)

---

## ⚠️ ملاحظات مهمة

### 1. أدوار متعددة
- المستخدم يمكن أن يكون له أكثر من دور
- مثال: مستخدم يكون `user` و `seller` و `admin` في نفس الوقت

### 2. الأمان
- جملة `ON CONFLICT DO NOTHING` تمنع التكرار
- آمن لتنفيذه عدة مرات

### 3. أدوار مؤقتة
يمكنك منح أدمن لفترة محددة:

```sql
INSERT INTO user_roles (user_id, role_id, granted_at, expires_at)
VALUES (
    5,
    (SELECT id FROM roles WHERE slug = 'admin'),
    NOW(),
    NOW() + INTERVAL '7 days'  -- تنتهي بعد 7 أيام
);
```

### 4. التحقق قبل الإضافة
```sql
-- تحقق إذا المستخدم أدمن بالفعل
SELECT EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = 5 AND r.slug = 'admin'
) as هل_أدمن;
```

---

## 🚀 دليل سريع خطوة بخطوة

### الطريقة الأسرع (أمر واحد):

1. **افتح phpMyAdmin أو PostgreSQL Client**

2. **نفذ هذا الأمر** (غيّر الإيميل):
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW()
FROM users u, roles r
WHERE u.email = 'test@test.com' AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

3. **تحقق من النجاح:**
```sql
SELECT u.username, u.email, STRING_AGG(r.slug, ', ') as roles
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.email = 'test@test.com'
GROUP BY u.id, u.username, u.email;
```

✅ **خلاص! المستخدم صار أدمن**

---

## 🎉 النتيجة المتوقعة

بعد تنفيذ الأوامر، المستخدم سيصبح عنده:
- ✅ صلاحيات الوصول للوحة الأدمن
- ✅ صلاحيات استخدام Admin APIs (`/api/admin/*`)
- ✅ إمكانية إدارة المستخدمين، المنتجات، الطلبات، إلخ
- ✅ سجل في جدول `user_roles` يربطه بدور admin

---

## 🔧 حل المشاكل

### المشكلة: "role not found"
**الحل:** تأكد من وجود دور admin:
```sql
SELECT * FROM roles WHERE slug = 'admin';
```

إذا لم يكن موجود، أنشئه:
```sql
INSERT INTO roles (name, slug, description, is_active, created_at, updated_at)
VALUES ('Admin', 'admin', 'Full system access', true, NOW(), NOW());
```

### المشكلة: "user not found"
**الحل:** تحقق من الإيميل:
```sql
SELECT id, username, email FROM users WHERE email LIKE '%test%';
```

### المشكلة: "duplicate key"
**المعنى:** المستخدم بالفعل أدمن! ✅
```sql
-- تحقق من أدواره
SELECT r.slug FROM user_roles ur
JOIN roles r ON ur.role_id = r.id
WHERE ur.user_id = 5;
```

---

## 📝 أمثلة إضافية

### منح عدة مستخدمين دور أدمن دفعة واحدة
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW()
FROM users u, roles r
WHERE u.email IN ('user1@test.com', 'user2@test.com', 'user3@test.com')
AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

### منح جميع الـ sellers دور أدمن
```sql
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT DISTINCT ur.user_id, r.id, NOW()
FROM user_roles ur
CROSS JOIN roles r
WHERE ur.role_id = (SELECT id FROM roles WHERE slug = 'seller')
AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

---

## 🎯 الخلاصة

**أسرع طريقة:**
```sql
-- غيّر الإيميل فقط وشغّل
INSERT INTO user_roles (user_id, role_id, granted_at)
SELECT u.id, r.id, NOW() FROM users u, roles r
WHERE u.email = 'الإيميل_هنا@example.com' AND r.slug = 'admin'
ON CONFLICT DO NOTHING;
```

**تحقق:**
```sql
-- تأكد من النجاح
SELECT u.username, STRING_AGG(r.slug, ', ') as roles
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
WHERE u.email = 'الإيميل_هنا@example.com'
GROUP BY u.username;
```

✅ **تم! المستخدم صار أدمن بنجاح!** 🎉
